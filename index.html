<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patient Log - Health Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/brython@3.10.3/brython.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/brython@3.10.3/brython_stdlib.js"></script>
  <style>
    :root{--dark:#2f2f2f;--card:#fff;--accent:#f9f0b8}
    body{margin:0;font-family: 'Poppins', Arial, sans-serif;background:var(--accent);}
    .topbar{background:var(--dark);color:#fff;padding:22px 36px;box-shadow:0 3px 0 rgba(0,0,0,0.06)}
    .brand{font-size:28px;font-weight:700}
    .container{max-width:900px;margin:36px auto;padding:24px;background:var(--card);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    h1{margin-top:0;text-align:center;font-size:30px}

    .intro{color:#555;text-align:center;line-height:1.6}
    .panel{margin-top:22px;background:#fafafa;padding:22px;border-radius:10px;box-shadow:inset 0 1px 0 rgba(0,0,0,0.02)}

    label{display:block;margin:12px 0 6px;color:#333}
    input[type=text], input[type=number], input[type=email], input[type=tel], select{width:100%;padding:12px;border:1px solid #e6e6e6;border-radius:6px;font-size:15px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .btn{display:inline-block;padding:10px 14px;border-radius:8px;background:#2f2f2f;color:#fff;border:none;cursor:pointer}
    .muted{color:#777}

    .actions{margin-top:12px}
    .results{margin-top:18px;background:#fff;padding:12px;border-radius:8px}
    .list{margin-top:12px}
    .patient-item{padding:8px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .patient-item:last-child{border-bottom:none}
    .badge{background:#f1f1f1;padding:6px 8px;border-radius:6px;font-size:13px}

    .flex{display:flex;gap:12px;align-items:center}

    footer{margin-top:18px;text-align:center;color:#999}

    @media (max-width:700px){.row{flex-direction:column}}
  </style>
</head>
<body onload="brython()">
  <div class="topbar">
    <div class="brand">Patient Log</div>
  </div>

  <div class="container">
    <h1>Welcome to Patient Log</h1>
    <p class="intro">This platform helps you efficiently manage patient records, track appointments, and run a quick health analysis. Use the form below to add or search patients.</p>

    <div class="panel">
      <label>Enter Patient ID:</label>
      <div class="row">
        <input id="search_id" type="text" placeholder="e.g., P12345" />
        <button class="btn" id="search_btn">Search</button>
      </div>

      <p class="muted" style="margin-top:14px">Click here to create new patient:</p>
      <button class="btn" id="new_btn" style="background:#444">Click Here</button>

      <div id="formwrap" style="display:none;margin-top:18px" class="results">
        <form id="patient_form">
          <label>Patient ID</label>
          <input id="pid" type="text" required />

          <label>Full name</label>
          <input id="name" type="text" required />

          <div class="row">
            <div class="col">
              <label>Serial number</label>
              <input id="srno" type="text" />
            </div>
            <div class="col">
              <label>Appointment number</label>
              <input id="apptnum" type="text" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Age</label>
              <input id="age" type="number" min="0" />
            </div>
            <div class="col">
              <label>Height (m)</label>
              <input id="ht" step="0.01" type="number" />
            </div>
            <div class="col">
              <label>Weight (kg)</label>
              <input id="wt" step="0.1" type="number" />
            </div>
          </div>

          <label>Prior medical history</label>
          <input id="prior_history" type="text" placeholder="Or None" />

          <div class="row">
            <div class="col">
              <label>Blood pressure (systolic/diastolic)</label>
              <input id="bp_raw" type="text" placeholder="e.g., 120/80" />
            </div>
            <div class="col">
              <label>Fasting sugar (mg/dL)</label>
              <input id="fasting" type="number" step="0.1" />
            </div>
            <div class="col">
              <label>Post-meal sugar (mg/dL)</label>
              <input id="postmeal" type="number" step="0.1" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Phone number</label>
              <input id="phnum" type="tel" />
            </div>
            <div class="col">
              <label>Email</label>
              <input id="email" type="email" />
            </div>
            <div class="col">
              <label>Emergency contact</label>
              <input id="emnum" type="text" />
            </div>
          </div>

          <div class="actions">
            <button type="button" class="btn" id="save_btn">Save & Analyze</button>
            <button type="button" class="btn" id="update_btn" style="display:none;background:#577">Update</button>
            <button type="button" class="btn" id="cancel_btn" style="background:#999">Cancel</button>
          </div>
        </form>

        <div id="analysis" style="margin-top:12px"></div>
      </div>

      <div id="listwrap" class="list" style="margin-top:18px"></div>

    </div>

    <footer>Built with Brython — Patient analyzer & local database (browser)</footer>
  </div>

  <script type="text/python">
from browser import document, html, alert
import re, json

STORAGE_KEY = 'patients_db_v1'

# --- ported functions (kept names close to original) ---

def calculate_bmi(weight, height):
    try:
        bmi = weight / (height ** 2)
    except Exception:
        return None, 'Invalid'
    if bmi < 18.5:
        cat = 'Underweight'
    elif 18.5 <= bmi < 24.9:
        cat = 'Normal weight'
    elif 25 <= bmi < 29.9:
        cat = 'Overweight'
    else:
        cat = 'Obese'
    return round(bmi,2), cat


def bp_analyzer(systolic, diastolic):
    if systolic < 90 or diastolic < 60:
        return 'Low Blood Pressure'
    elif 90 <= systolic <= 120 and 60 <= diastolic <= 80:
        return 'Normal'
    elif 120 < systolic <= 139 or 80 < diastolic <= 89:
        return 'Prehypertension'
    elif 140 <= systolic <= 159 or 90 <= diastolic <= 99:
        return 'Stage 1 Hypertension'
    else:
        return 'Stage 2 Hypertension'


def blood_sugar_analyzer(fasting, post_meal):
    if fasting < 70 or post_meal < 90:
        return 'Low Blood Sugar (Hypoglycemia)'
    elif 70 <= fasting <= 100 and post_meal < 140:
        return 'Normal'
    elif 100 < fasting <= 125 or 140 <= post_meal <= 199:
        return 'Prediabetes'
    else:
        return 'Diabetes'


def gen_health_adv(category, bp_status, sugar_status):
    adv_list = []
    if category == 'Underweight':
        adv_list.append('Increase calorie intake and consult a nutritionist.')
    elif category == 'Normal weight':
        adv_list.append('Maintain your healthy diet and lifestyle.')
    elif category == 'Overweight':
        adv_list.append('Reduce sugary/fatty foods.')
    else:
        adv_list.append('Follow structured weight-loss plan and consult a doctor.')

    if bp_status == 'Low Blood Pressure':
        adv_list.append('Increase fluids and avoid sudden standing.')
    elif bp_status == 'Normal':
        adv_list.append('Blood pressure is healthy.')
    elif bp_status == 'Prehypertension':
        adv_list.append('Reduce salt and improve lifestyle.')
    elif bp_status == 'Stage 1 Hypertension':
        adv_list.append('Avoid salt, alcohol, and monitor BP often.')
    else:
        adv_list.append('Consult a cardiologist immediately!')

    if sugar_status == 'Low Blood Sugar (Hypoglycemia)':
        adv_list.append('Carry easy sugar source and eat frequent meals.')
    elif sugar_status == 'Normal':
        adv_list.append('Sugar levels are normal, maintain diet.')
    elif sugar_status == 'Prediabetes':
        adv_list.append('Reduce carbs and increase exercise.')
    else:
        adv_list.append('Follow diabetic diet and consult doctor.')

    return adv_list


def assign_doc(bmi_category, bp_status, sugar_status):
    doctors = []
    if bmi_category in ['Underweight', 'Overweight', 'Obese']:
        doctors.append('Nutritionist')
    if bp_status in ['Prehypertension', 'Stage 1 Hypertension', 'Stage 2 Hypertension']:
        doctors.append('Cardiologist')
    if bp_status == 'Low Blood Pressure':
        doctors.append('Internal Medicine Specialist')
    if sugar_status in ['Prediabetes', 'Diabetes']:
        doctors.append('Diabetologist')
    if sugar_status == 'Low Blood Sugar (Hypoglycemia)':
        doctors.append('General Physician')
    if not doctors:
        doctors.append('General Physician (Checkup if necessary)')
    return doctors

# --- storage helpers ---

def load_db():
    try:
        raw = window.localStorage.getItem(STORAGE_KEY)
        if not raw:
            return {}
        return json.loads(raw)
    except Exception:
        return {}


def save_db(db):
    window.localStorage.setItem(STORAGE_KEY, json.dumps(db))

# --- UI interactions ---

from browser import window

doc = document

formwrap = doc['formwrap']
listwrap = doc['listwrap']
analysis = doc['analysis']

save_btn = doc['save_btn']
new_btn = doc['new_btn']
cancel_btn = doc['cancel_btn']
search_btn = doc['search_btn']
search_id = doc['search_id']
update_btn = doc['update_btn']


def clear_form():
    for id in ['pid','name','srno','apptnum','age','ht','wt','prior_history','bp_raw','fasting','postmeal','phnum','email','emnum']:
        doc[id].value = ''
    analysis.clear()
    update_btn.style.display = 'none'
    save_btn.style.display = ''


def render_list():
    db = load_db()
    listwrap.clear()
    if not db:
        listwrap <= html.DIV('No patients yet. Add new patient to begin.', Class='muted')
        return
    for pid, p in db.items():
        item = html.DIV(Class='patient-item')
        left = html.DIV(f"{p.get('Name','-')} — {pid}")
        right = html.DIV()
        btn_view = html.BUTTON('View', Class='btn')
        btn_view.attrs['data-pid'] = pid
        btn_edit = html.BUTTON('Edit', Class='btn')
        btn_edit.style.background = '#577'
        btn_edit.attrs['data-pid'] = pid
        btn_del = html.BUTTON('Delete', Class='btn')
        btn_del.style.background = '#b33'
        btn_del.attrs['data-pid'] = pid
        right <= btn_view
        right <= html.SPAN(' ')
        right <= btn_edit
        right <= html.SPAN(' ')
        right <= btn_del
        item <= left
        item <= right
        listwrap <= item

        def make_view(ev, pid=pid):
            show_patient(pid)
        def make_edit(ev, pid=pid):
            edit_patient(pid)
        def make_del(ev, pid=pid):
            if window.confirm('Delete patient '+pid+' ?'):
                db = load_db()
                if pid in db:
                    del db[pid]
                    save_db(db)
                    render_list()
        btn_view.bind('click', make_view)
        btn_edit.bind('click', make_edit)
        btn_del.bind('click', make_del)


def show_patient(pid):
    db = load_db()
    p = db.get(pid)
    if not p:
        alert('Patient not found')
        return
    formwrap.style.display = ''
    # fill form readonly
    doc['pid'].value = pid
    doc['name'].value = p.get('Name','')
    doc['srno'].value = p.get('Serial Number','')
    doc['apptnum'].value = p.get('Appointment Number','')
    doc['age'].value = p.get('Age','')
    doc['ht'].value = p.get('Height (m)','')
    doc['wt'].value = p.get('Weight (kg)','')
    doc['prior_history'].value = p.get('Prior Medical History','')
    doc['bp_raw'].value = f"{p.get('Systolic BP','')}/{p.get('Diastolic BP','')}"
    doc['fasting'].value = p.get('Fasting Sugar','')
    doc['postmeal'].value = p.get('Post Meal Sugar','')
    doc['phnum'].value = p.get('Phone Number','')
    doc['email'].value = p.get('Email ID','')
    doc['emnum'].value = p.get('Emergency Contact','')
    analyze_current()


def edit_patient(pid):
    show_patient(pid)
    update_btn.style.display = ''
    save_btn.style.display = 'none'


def parse_bp(raw):
    try:
        s,d = raw.split('/')
        return int(s.strip()), int(d.strip())
    except Exception:
        return None, None


def analyze_current():
    try:
        wt = float(doc['wt'].value)
        ht = float(doc['ht'].value)
    except Exception:
        wt = ht = None
    bp_raw = doc['bp_raw'].value.strip()
    s,d = parse_bp(bp_raw)
    try:
        fasting = float(doc['fasting'].value)
    except Exception:
        fasting = 0.0
    try:
        postmeal = float(doc['postmeal'].value)
    except Exception:
        postmeal = 0.0

    bmi, cat = (None, 'Invalid')
    if wt and ht:
        bmi, cat = calculate_bmi(wt, ht)
    bp_stat = bp_analyzer(s,d) if s and d else 'Unknown'
    sugar_stat = blood_sugar_analyzer(fasting, postmeal)

    analysis.clear()
    analysis <= html.H3('HEALTH REPORT')
    analysis <= html.DIV(f"BMI: {bmi} ({cat})")
    analysis <= html.DIV(f"Blood Pressure Status: {bp_stat}")
    analysis <= html.DIV(f"Blood Sugar Status: {sugar_stat}")

    analysis <= html.H4('ADVICE')
    for a in gen_health_adv(cat, bp_stat, sugar_stat):
        analysis <= html.DIV('• '+a)
    analysis <= html.H4('RECOMMENDED DOCTORS')
    for d in assign_doc(cat, bp_stat, sugar_stat):
        analysis <= html.DIV('• '+d)


# --- event handlers ---

def on_new(ev):
    formwrap.style.display = ''
    clear_form()


def on_cancel(ev):
    formwrap.style.display = 'none'


def on_save(ev):
    pid = doc['pid'].value.strip()
    if not pid:
        alert('Patient ID is required')
        return
    # basic email validation
    email = doc['email'].value.strip()
    if email and not re.match(r"[^@]+@[^@]+\.[^@]+", email):
        alert('Invalid email')
        return
    bp_raw = doc['bp_raw'].value.strip()
    s,d = parse_bp(bp_raw)
    patient = {
        'Name': doc['name'].value.strip(),
        'Serial Number': doc['srno'].value.strip(),
        'Appointment Number': doc['apptnum'].value.strip(),
        'Age': doc['age'].value or '',
        'Height (m)': float(doc['ht'].value) if doc['ht'].value else '',
        'Weight (kg)': float(doc['wt'].value) if doc['wt'].value else '',
        'Prior Medical History': doc['prior_history'].value.strip(),
        'Systolic BP': s or '',
        'Diastolic BP': d or '',
        'Fasting Sugar': float(doc['fasting'].value) if doc['fasting'].value else 0.0,
        'Post Meal Sugar': float(doc['postmeal'].value) if doc['postmeal'].value else 0.0,
        'Phone Number': doc['phnum'].value.strip(),
        'Email ID': email,
        'Emergency Contact': doc['emnum'].value.strip()
    }
    db = load_db()
    db[pid] = patient
    save_db(db)
    render_list()
    analyze_current()
    alert('Saved')


def on_update(ev):
    # same as save but require pid exists
    pid = doc['pid'].value.strip()
    db = load_db()
    if pid not in db:
        alert('Patient not found to update')
        return
    on_save(ev)
    update_btn.style.display = 'none'
    save_btn.style.display = ''


def on_search(ev):
    pid = search_id.value.strip()
    if not pid:
        alert('Enter a Patient ID to search')
        return
    show_patient(pid)


new_btn.bind('click', on_new)
cancel_btn.bind('click', on_cancel)
save_btn.bind('click', on_save)
update_btn.bind('click', on_update)
search_btn.bind('click', on_search)

# initial render
render_list()

  </script>
</body>
</html>
